#!/usr/bin/env bash
set -euo pipefail

# Always operate relative to repo root
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOOLS_DIR="$REPO_ROOT/tools"

usage() {
  cat <<'EOF'
envhub-platform helper CLI

Usage:
  ./envhub <command> [args...]

Commands:
  br:use                   Select profile/defconfig (prod|debug|qemu or defconfig name)
  br:menuconfig            Open Buildroot menuconfig for active profile (per-profile output dir)
  br:save-defconfig        Save current profile's .config back to active defconfig (or arg)
  br:build                 Build active profile (or pass prod|debug|qemu|defconfig to override)
  br:clean                 Clean active profile output (clean|dirclean|distclean) [optional profile]
  qemu                     Run QEMU using qemu profile output (or pass profile/defconfig)

Examples:
  ./envhub br:use qemu
  ./envhub br:build
  ./envhub qemu
  ./envhub qemu qemu            # explicitly
  ./envhub br:clean distclean qemu
EOF
}

cmd="${1:-}"
shift || true

case "$cmd" in
  br:use)               exec "$TOOLS_DIR/br_use_defconfig.sh" "$@" ;;
  br:menuconfig)        exec "$TOOLS_DIR/br_menuconfig.sh" "$@" ;;
  br:save-defconfig)    exec "$TOOLS_DIR/br_savedefconfig.sh" "$@" ;;
  br:build)             exec "$TOOLS_DIR/br_build.sh" "$@" ;;
  br:clean)             exec "$TOOLS_DIR/br_clean.sh" "$@" ;;
  qemu)                 exec "$TOOLS_DIR/qemu_run.sh" "$@" ;;
  deploy)               exec "$TOOLS_DIR/deploy_netboot.sh" "$@" ;;
  -h|--help|help|"")    usage; exit 0 ;;
  *) echo "Unknown command: $cmd" >&2; usage; exit 2 ;;
esac